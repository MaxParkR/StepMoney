<!--
  Vista de Metas de Ahorro - Diseño Moderno
  Muestra las metas del usuario con su progreso
-->

<ion-content [fullscreen]="true" class="goals-content">
  
  <!-- Refresh -->
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- Header Minimalista -->
  <div class="page-header">
    <h1 class="page-title">Mis Metas</h1>
  </div>

  <!-- Loading -->
  <div *ngIf="isLoading" class="loading-container">
    <ion-spinner name="crescent" color="primary"></ion-spinner>
  </div>

  <!-- Contenido -->
  <div *ngIf="!isLoading">
    
    <!-- Estadísticas Generales - Diseño Moderno -->
    <div class="stats-section-modern">
      <div class="stats-header">
        <h2>Resumen de Ahorro</h2>
        <ion-icon name="sparkles-outline"></ion-icon>
      </div>
      
      <div class="total-saved-card">
        <div class="total-saved-content">
          <p class="label">Total Ahorrado</p>
          <h1 class="amount">{{ formatCurrency(stats.totalSavedAmount) }}</h1>
          <p class="target">Meta: {{ formatCurrency(stats.totalTargetAmount) }}</p>
          <ion-progress-bar 
            [value]="stats.overallProgress / 100" 
            color="light"
            class="global-progress">
          </ion-progress-bar>
        </div>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card active-stat">
          <div class="stat-icon">
            <ion-icon name="flag"></ion-icon>
          </div>
          <div class="stat-info">
            <p>Activas</p>
            <h3>{{ stats.activeGoals }}</h3>
          </div>
        </div>
        <div class="stat-card completed-stat">
          <div class="stat-icon">
            <ion-icon name="checkmark-circle"></ion-icon>
          </div>
          <div class="stat-info">
            <p>Completadas</p>
            <h3>{{ stats.completedGoals }}</h3>
          </div>
        </div>
        <div class="stat-card progress-stat">
          <div class="stat-icon">
            <ion-icon name="trending-up"></ion-icon>
          </div>
          <div class="stat-info">
            <p>Progreso</p>
            <h3>{{ stats.overallProgress.toFixed(0) }}%</h3>
          </div>
        </div>
      </div>
    </div>

    <!-- Filtros de Vista -->
    <div class="filter-container">
      <ion-segment [value]="currentView" (ionChange)="onViewChange($event)">
        <ion-segment-button value="active">
          <ion-label>Activas ({{ activeGoals.length }})</ion-label>
        </ion-segment-button>
        <ion-segment-button value="completed">
          <ion-label>Completadas ({{ completedGoals.length }})</ion-label>
        </ion-segment-button>
      </ion-segment>
    </div>

    <!-- Lista de Metas Activas -->
    <div *ngIf="currentView === 'active'">
      
      <!-- Metas Activas - Diseño Moderno -->
      <div class="goals-list-modern">
        <div *ngFor="let goal of activeGoals" class="goal-card-modern">
          <div class="goal-card-header">
            <div class="goal-icon-modern" 
                 [style.background]="goal.color + '20'"
                 [style.border-color]="goal.color">
              <ion-icon 
                [name]="goal.icon"
                [style.color]="goal.color">
              </ion-icon>
            </div>
            <div class="goal-title-section">
              <h3>{{ goal.name }}</h3>
              <p *ngIf="goal.description">{{ goal.description }}</p>
            </div>
            <ion-badge 
              [color]="getStatusColor(getProgress(goal.id)!)" 
              *ngIf="getProgress(goal.id)"
              class="status-badge">
              {{ getStatusText(getProgress(goal.id)!) }}
            </ion-badge>
          </div>

          <div class="goal-progress-modern" *ngIf="getProgress(goal.id) as progress">
            <div class="progress-info-row">
              <div class="current-amount">
                <span class="amount-label">Ahorrado</span>
                <span class="amount-value">{{ formatCurrency(goal.currentAmount) }}</span>
              </div>
              <div class="progress-percentage-big">
                <span>{{ progress.percentage }}%</span>
              </div>
            </div>
            <ion-progress-bar 
              [value]="progress.percentage / 100" 
              [color]="getStatusColor(progress)"
              class="modern-progress-bar">
            </ion-progress-bar>
            <div class="target-row">
              <span class="target-label">Meta: {{ formatCurrency(goal.targetAmount) }}</span>
              <span class="remaining-label">Faltan: {{ formatCurrency(progress.remaining) }}</span>
            </div>
          </div>

          <div class="goal-details-modern" *ngIf="getProgress(goal.id) as progress">
            <div class="detail-card" *ngIf="goal.deadline">
              <ion-icon name="calendar-outline"></ion-icon>
              <div class="detail-text">
                <span class="detail-label">Fecha Límite</span>
                <span class="detail-value">{{ formatDate(goal.deadline) }}</span>
                <span class="days-chip" *ngIf="progress.daysRemaining">
                  {{ progress.daysRemaining }} días
                </span>
              </div>
            </div>
            <div class="detail-card" *ngIf="progress.dailyRequired">
              <ion-icon name="trending-up-outline"></ion-icon>
              <div class="detail-text">
                <span class="detail-label">Ahorro Diario Requerido</span>
                <span class="detail-value">{{ formatCurrency(progress.dailyRequired) }}</span>
              </div>
            </div>
          </div>

          <div class="goal-actions-modern">
            <ion-button 
              expand="block" 
              (click)="openContributeModal(goal)"
              class="contribute-button"
              [color]="goal.currentAmount >= goal.targetAmount ? 'success' : 'primary'">
              <ion-icon name="add-circle" slot="start"></ion-icon>
              Agregar Ahorro
            </ion-button>
            <ion-button 
              fill="clear" 
              color="secondary"
              (click)="openEditGoalModal(goal)"
              class="edit-button">
              <ion-icon name="create-outline"></ion-icon>
              Editar Ahorro
            </ion-button>
            <ion-button 
              fill="clear" 
              color="danger" 
              (click)="deleteGoal(goal)"
              class="delete-button">
              <ion-icon name="trash-outline"></ion-icon>
            </ion-button>
          </div>
        </div>
      </div>

      <!-- Estado vacío (sin metas activas) -->
      <div *ngIf="activeGoals.length === 0" class="empty-state">
        <ion-icon name="flag-outline" size="large" color="medium"></ion-icon>
        <h2>No tienes metas activas</h2>
        <p class="text-muted">
          Crea tu primera meta de ahorro y comienza a trabajar hacia tus objetivos financieros
        </p>
        <ion-button (click)="openAddGoalModal()">
          <ion-icon name="add" slot="start"></ion-icon>
          Crear Primera Meta
        </ion-button>
      </div>
    </div>

    <!-- Lista de Metas Completadas -->
    <div *ngIf="currentView === 'completed'" class="completed-goals-container">
      
      <div *ngFor="let goal of completedGoals" class="completed-goal-card">
        <!-- Ribbon de completada -->
        <div class="completed-ribbon">
          <ion-icon name="checkmark-circle"></ion-icon>
          <span>¡Meta Lograda!</span>
        </div>

        <!-- Header con confetti visual -->
        <div class="completed-card-header">
          <div class="completed-icon-wrapper" [style.background]="goal.color">
              <ion-icon [name]="goal.icon"></ion-icon>
            <div class="success-badge">
              <ion-icon name="checkmark"></ion-icon>
            </div>
            </div>
          <div class="completed-info">
            <h3>{{ goal.name }}</h3>
            <p *ngIf="goal.description" class="description">{{ goal.description }}</p>
          </div>
          </div>

        <!-- Monto ahorrado destacado -->
        <div class="completed-amount-section">
          <div class="trophy-icon">
            <ion-icon name="trophy"></ion-icon>
            </div>
          <div class="amount-details">
            <span class="amount-label">Total Ahorrado</span>
            <span class="amount-value">{{ formatCurrency(goal.currentAmount) }}</span>
          </div>
        </div>

        <!-- Fecha de completación -->
        <div class="completed-date" *ngIf="goal.completedAt">
          <ion-icon name="calendar-outline"></ion-icon>
          <span>Completada el {{ formatDate(goal.completedAt) }}</span>
        </div>

        <!-- Progress bar al 100% -->
        <div class="completed-progress">
          <div class="progress-bar-full"></div>
          <span class="progress-label">100% Completado</span>
        </div>

        <!-- Acciones -->
        <div class="completed-actions">
          <ion-button 
            fill="outline" 
            color="medium"
            size="small"
            (click)="openEditGoalModal(goal)">
            <ion-icon name="create-outline" slot="start"></ion-icon>
            Editar
          </ion-button>
          <ion-button 
            fill="outline" 
            color="danger"
            size="small" 
            (click)="deleteGoal(goal)">
            <ion-icon name="trash-outline" slot="start"></ion-icon>
            Eliminar
          </ion-button>
        </div>
      </div>

      <!-- Estado vacío (sin metas completadas) -->
      <div *ngIf="completedGoals.length === 0" class="empty-state">
        <div class="empty-icon-wrapper">
          <ion-icon name="trophy-outline"></ion-icon>
        </div>
        <h2>Aún no has completado ninguna meta</h2>
        <p class="text-muted">
          Sigue ahorrando en tus metas activas para verlas aquí
        </p>
      </div>
    </div>

    <!-- Espaciado inferior -->
    <div style="height: 80px;"></div>
  </div>

</ion-content>

<!-- Botón flotante para agregar meta -->
<ion-fab vertical="bottom" horizontal="end" slot="fixed" *ngIf="!isLoading">
  <ion-fab-button (click)="openAddGoalModal()">
    <ion-icon name="add"></ion-icon>
  </ion-fab-button>
</ion-fab>

<!-- Modal para Nueva Meta -->
<ion-modal [isOpen]="isAddingGoal" (didDismiss)="closeAddGoalModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Nueva Meta de Ahorro</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeAddGoalModal()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    
    <ion-content>
      <div class="modal-content">
        
        <!-- Nombre -->
        <ion-item>
          <ion-label position="stacked">Nombre de la Meta *</ion-label>
          <ion-input 
            [(ngModel)]="newGoal.name" 
            placeholder="Ej: Vacaciones, Laptop nueva, Fondo emergencia">
          </ion-input>
        </ion-item>

        <!-- Descripción -->
        <ion-item>
          <ion-label position="stacked">Descripción (opcional)</ion-label>
          <ion-textarea 
            [(ngModel)]="newGoal.description" 
            placeholder="¿Para qué es esta meta?"
            rows="2">
          </ion-textarea>
        </ion-item>

        <!-- Monto Objetivo -->
        <ion-item>
          <ion-label position="stacked">Monto Objetivo *</ion-label>
          <ion-input 
            type="number" 
            [(ngModel)]="newGoal.targetAmount" 
            placeholder="0"
            inputmode="decimal">
          </ion-input>
        </ion-item>

        <!-- Fecha Límite -->
        <ion-item>
          <ion-label position="stacked">Fecha Límite (opcional)</ion-label>
          <ion-input 
            type="date" 
            [(ngModel)]="newGoal.deadline">
          </ion-input>
        </ion-item>

        <!-- Icono -->
        <div class="icon-selector">
          <p class="selector-label">Selecciona un Icono:</p>
          <div class="icon-grid">
            <div 
              *ngFor="let icon of availableIcons" 
              class="icon-option"
              [class.selected]="newGoal.icon === icon"
              (click)="newGoal.icon = icon">
              <ion-icon [name]="icon"></ion-icon>
            </div>
          </div>
        </div>

        <!-- Color -->
        <div class="color-selector">
          <p class="selector-label">Selecciona un Color:</p>
          <div class="color-grid">
            <div 
              *ngFor="let color of availableColors" 
              class="color-option"
              [style.background-color]="color"
              [class.selected]="newGoal.color === color"
              (click)="newGoal.color = color">
              <ion-icon name="checkmark" *ngIf="newGoal.color === color"></ion-icon>
            </div>
          </div>
        </div>

        <!-- Vista Previa -->
        <div class="preview-card">
          <p class="text-muted">Vista Previa:</p>
          <div class="preview-icon" [style.background-color]="newGoal.color">
            <ion-icon [name]="newGoal.icon"></ion-icon>
          </div>
        </div>

        <!-- Botón de guardar -->
        <div class="form-actions">
          <ion-button expand="block" (click)="saveGoal()" color="primary">
            <ion-icon name="checkmark-circle" slot="start"></ion-icon>
            Crear Meta
          </ion-button>
        </div>

      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Modal para Editar Meta -->
<ion-modal [isOpen]="isEditingGoal" (didDismiss)="closeEditGoalModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Editar Meta de Ahorro</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeEditGoalModal()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    
    <ion-content *ngIf="editingGoal">
      <div class="modal-content">
        
        <!-- Nombre -->
        <ion-item>
          <ion-label position="stacked">Nombre de la Meta *</ion-label>
          <ion-input 
            [(ngModel)]="editingGoal.name" 
            placeholder="Ej: Vacaciones, Laptop nueva, Fondo emergencia">
          </ion-input>
        </ion-item>

        <!-- Descripción -->
        <ion-item>
          <ion-label position="stacked">Descripción (opcional)</ion-label>
          <ion-textarea 
            [(ngModel)]="editingGoal.description" 
            placeholder="¿Para qué es esta meta?"
            rows="2">
          </ion-textarea>
        </ion-item>

        <!-- Monto Objetivo -->
        <ion-item>
          <ion-label position="stacked">Monto Objetivo *</ion-label>
          <ion-input 
            type="number" 
            [(ngModel)]="editingGoal.targetAmount" 
            placeholder="0"
            inputmode="decimal">
          </ion-input>
        </ion-item>

        <!-- Fecha Límite -->
        <ion-item>
          <ion-label position="stacked">Fecha Límite (opcional)</ion-label>
          <ion-input 
            type="date" 
            [(ngModel)]="editingGoal.deadline">
          </ion-input>
        </ion-item>

        <!-- Icono -->
        <div class="icon-selector">
          <p class="selector-label">Selecciona un Icono:</p>
          <div class="icon-grid">
            <div 
              *ngFor="let icon of availableIcons" 
              class="icon-option"
              [class.selected]="editingGoal.icon === icon"
              (click)="editingGoal.icon = icon">
              <ion-icon [name]="icon"></ion-icon>
            </div>
          </div>
        </div>

        <!-- Color -->
        <div class="color-selector">
          <p class="selector-label">Selecciona un Color:</p>
          <div class="color-grid">
            <div 
              *ngFor="let color of availableColors" 
              class="color-option"
              [style.background-color]="color"
              [class.selected]="editingGoal.color === color"
              (click)="editingGoal.color = color">
              <ion-icon name="checkmark" *ngIf="editingGoal.color === color"></ion-icon>
            </div>
          </div>
        </div>

        <!-- Vista Previa -->
        <div class="preview-card">
          <p class="text-muted">Vista Previa:</p>
          <div class="preview-icon" [style.background-color]="editingGoal.color">
            <ion-icon [name]="editingGoal.icon"></ion-icon>
          </div>
        </div>

        <!-- Botón de guardar -->
        <div class="form-actions">
          <ion-button expand="block" (click)="saveEditedGoal()" color="primary">
            <ion-icon name="checkmark-circle" slot="start"></ion-icon>
            Guardar Cambios
          </ion-button>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Modal para Contribuir -->
<ion-modal [isOpen]="isContributing" (didDismiss)="closeContributeModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Agregar Ahorro</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeContributeModal()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    
    <ion-content *ngIf="selectedGoalForContribution">
      <div class="modal-content">
        
        <!-- Información de la meta -->
        <div class="contribution-goal-info">
          <div class="goal-icon" [style.background-color]="selectedGoalForContribution.color">
            <ion-icon [name]="selectedGoalForContribution.icon"></ion-icon>
          </div>
          <div class="goal-details">
            <h3>{{ selectedGoalForContribution.name }}</h3>
            <p>{{ formatCurrency(selectedGoalForContribution.currentAmount) }} de {{ formatCurrency(selectedGoalForContribution.targetAmount) }}</p>
          </div>
        </div>

        <!-- Estadísticas de la meta -->
        <div class="contribution-stats">
          <div class="stat-item">
            <span class="stat-label">Progreso Actual</span>
            <span class="stat-value highlight">{{ getProgress(selectedGoalForContribution.id)?.percentage || 0 }}%</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Falta por ahorrar</span>
            <span class="stat-value">{{ formatCurrency(selectedGoalForContribution.targetAmount - selectedGoalForContribution.currentAmount) }}</span>
          </div>
        </div>

        <!-- Campo de monto -->
        <ion-item>
          <ion-label position="stacked">Monto a Ahorrar *</ion-label>
          <ion-input 
            type="number" 
            [(ngModel)]="contributionAmount" 
            placeholder="Ingresa el monto"
            inputmode="decimal">
          </ion-input>
        </ion-item>

        <!-- Nota opcional -->
        <ion-item>
          <ion-label position="stacked">Nota (opcional)</ion-label>
          <ion-textarea 
            [(ngModel)]="contributionNote" 
            placeholder="Ej: Ahorro del mes de diciembre"
            rows="2">
          </ion-textarea>
        </ion-item>

        <!-- Botón de guardar -->
        <div class="form-actions">
          <ion-button expand="block" (click)="saveContribution()" color="success">
            <ion-icon name="wallet" slot="start"></ion-icon>
            Agregar {{ formatCurrency(contributionAmount || 0) }}
          </ion-button>
        </div>

      </div>
    </ion-content>
  </ng-template>
</ion-modal>
