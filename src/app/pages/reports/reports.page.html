<!--
  Página de Reportes Financieros - Diseño Moderno
-->

<ion-content [fullscreen]="true" class="reports-content">
  
  <!-- Refresher -->
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- Header -->
  <div class="page-header">
    <h1 class="page-title">Reportes</h1>
    <ion-button fill="clear" (click)="downloadReport()" class="download-btn">
      <ion-icon slot="icon-only" name="download-outline"></ion-icon>
    </ion-button>
  </div>

  <!-- Selector de Mes -->
  <div class="month-selector">
    <button class="month-nav-btn" (click)="previousMonth()">
      <ion-icon name="chevron-back"></ion-icon>
    </button>
    <div class="month-display" (click)="goToCurrentMonth()">
      <span class="month-name">{{ getSelectedPeriodLabel() }}</span>
      <span class="current-badge" *ngIf="!isCurrentMonth()">Ir a hoy</span>
    </div>
    <button class="month-nav-btn" (click)="nextMonth()">
      <ion-icon name="chevron-forward"></ion-icon>
    </button>
  </div>

  <!-- Loading -->
  <div *ngIf="isLoading" class="loading-container">
    <ion-spinner name="crescent" color="primary"></ion-spinner>
    <p>Generando reportes...</p>
  </div>

  <!-- Contenido -->
  <div *ngIf="!isLoading">
    
    <!-- Tarjeta de Resumen Rápido -->
    <div class="quick-summary">
      <div class="summary-card-main" [class]="getBalanceClass()">
        <div class="summary-header">
          <span class="summary-label">Balance del Mes</span>
          <ion-icon [name]="summary.balance >= 0 ? 'trending-up' : 'trending-down'"></ion-icon>
        </div>
        <h1 class="summary-amount">{{ formatCurrency(summary.balance) }}</h1>
        <div class="summary-details">
          <div class="detail-item income">
            <ion-icon name="arrow-down-circle"></ion-icon>
            <span>{{ formatCurrency(summary.totalIncome) }}</span>
          </div>
          <div class="detail-item expense">
            <ion-icon name="arrow-up-circle"></ion-icon>
            <span>{{ formatCurrency(summary.totalExpense) }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Selector de Vista -->
    <div class="view-selector">
      <ion-segment [value]="selectedView" (ionChange)="onViewChange($event)">
        <ion-segment-button value="charts">
          <ion-label>Gráficos</ion-label>
        </ion-segment-button>
        <ion-segment-button value="summary">
          <ion-label>Resumen</ion-label>
        </ion-segment-button>
      </ion-segment>
    </div>

    <!-- Vista de Gráficos -->
    <div *ngIf="selectedView === 'charts'" class="charts-container">
      
      <!-- Gráfico de Distribución de Gastos -->
      <div class="chart-card" *ngIf="summary.byCategory.length > 0">
        <div class="chart-header">
          <h3>Distribución de Gastos</h3>
          <span class="chart-subtitle">Por categoría</span>
        </div>
        <div class="chart-wrapper pie-chart">
          <canvas #pieChartCanvas></canvas>
        </div>
      </div>

      <!-- Gráfico de Ingresos vs Gastos -->
      <div class="chart-card">
        <div class="chart-header">
          <h3>Ingresos vs Gastos</h3>
          <span class="chart-subtitle">Últimos 6 meses</span>
        </div>
        <div class="chart-wrapper bar-chart">
          <canvas #barChartCanvas></canvas>
        </div>
      </div>

      <!-- Gráfico de Tendencia -->
      <div class="chart-card">
        <div class="chart-header">
          <h3>Tendencia de Balance</h3>
          <span class="chart-subtitle">Evolución mensual</span>
        </div>
        <div class="chart-wrapper line-chart">
          <canvas #lineChartCanvas></canvas>
        </div>
      </div>

      <!-- Empty state para gráficos -->
      <div *ngIf="!hasData" class="empty-state">
        <div class="empty-icon-wrapper">
          <ion-icon name="bar-chart-outline"></ion-icon>
        </div>
        <h2>No hay datos para mostrar</h2>
        <p>Registra transacciones para ver tus gráficos y estadísticas</p>
      </div>
    </div>

    <!-- Vista de Resumen -->
    <div *ngIf="selectedView === 'summary'" class="summary-container">
      
      <!-- Resumen del Mes -->
      <div class="summary-section">
        <div class="section-header">
          <ion-icon name="calendar"></ion-icon>
          <h3>Resumen del Mes</h3>
        </div>
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-icon income-bg">
              <ion-icon name="arrow-down"></ion-icon>
            </div>
            <div class="stat-info">
              <span class="stat-label">Ingresos</span>
              <span class="stat-value income">{{ formatCurrency(summary.totalIncome) }}</span>
            </div>
          </div>
          <div class="stat-item">
            <div class="stat-icon expense-bg">
              <ion-icon name="arrow-up"></ion-icon>
            </div>
            <div class="stat-info">
              <span class="stat-label">Gastos</span>
              <span class="stat-value expense">{{ formatCurrency(summary.totalExpense) }}</span>
            </div>
          </div>
          <div class="stat-item">
            <div class="stat-icon balance-bg">
              <ion-icon name="wallet"></ion-icon>
            </div>
            <div class="stat-info">
              <span class="stat-label">Balance</span>
              <span class="stat-value" [class]="getBalanceClass()">{{ formatCurrency(summary.balance) }}</span>
            </div>
          </div>
          <div class="stat-item">
            <div class="stat-icon neutral-bg">
              <ion-icon name="receipt"></ion-icon>
            </div>
            <div class="stat-info">
              <span class="stat-label">Transacciones</span>
              <span class="stat-value">{{ summary.transactionCount }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Top Categorías -->
      <div class="summary-section" *ngIf="topCategories.length > 0">
        <div class="section-header">
          <ion-icon name="pie-chart"></ion-icon>
          <h3>Top Categorías</h3>
        </div>
        <div class="categories-list">
          <div class="category-item" *ngFor="let cat of topCategories; let i = index">
            <div class="category-rank">{{ i + 1 }}</div>
            <div class="category-icon" [style.background]="cat.categoryColor + '20'">
              <ion-icon [name]="cat.categoryIcon" [style.color]="cat.categoryColor"></ion-icon>
            </div>
            <div class="category-info">
              <span class="category-name">{{ cat.categoryName }}</span>
              <div class="category-bar">
                <div class="category-progress" [style.width.%]="cat.percentage" [style.background]="cat.categoryColor"></div>
              </div>
            </div>
            <div class="category-amount">{{ formatCurrency(cat.total) }}</div>
          </div>
        </div>
      </div>

      <!-- Promedios -->
      <div class="summary-section">
        <div class="section-header">
          <ion-icon name="analytics"></ion-icon>
          <h3>Promedios (6 meses)</h3>
        </div>
        <div class="averages-grid">
          <div class="average-card">
            <span class="average-label">Ingreso Promedio</span>
            <span class="average-value income">{{ formatCurrency(averages.income) }}</span>
          </div>
          <div class="average-card">
            <span class="average-label">Gasto Promedio</span>
            <span class="average-value expense">{{ formatCurrency(averages.expense) }}</span>
          </div>
          <div class="average-card full-width">
            <span class="average-label">Balance Promedio</span>
            <span class="average-value" [class]="averages.balance >= 0 ? 'income' : 'expense'">
              {{ formatCurrency(averages.balance) }}
            </span>
          </div>
        </div>
      </div>

      <!-- Metas de Ahorro -->
      <div class="summary-section">
        <div class="section-header">
          <ion-icon name="trophy"></ion-icon>
          <h3>Metas de Ahorro</h3>
        </div>
        <div class="goals-summary">
          <div class="goals-progress-ring">
            <div class="progress-circle">
              <span class="progress-value">{{ goalsStats.overallProgress.toFixed(0) }}%</span>
              <span class="progress-label">Progreso</span>
            </div>
          </div>
          <div class="goals-stats">
            <div class="goal-stat">
              <span class="stat-number">{{ goalsStats.totalGoals }}</span>
              <span class="stat-text">Total</span>
            </div>
            <div class="goal-stat">
              <span class="stat-number active">{{ goalsStats.activeGoals }}</span>
              <span class="stat-text">Activas</span>
            </div>
            <div class="goal-stat">
              <span class="stat-number completed">{{ goalsStats.completedGoals }}</span>
              <span class="stat-text">Completadas</span>
            </div>
          </div>
          <div class="goals-amounts">
            <div class="amount-row">
              <span>Ahorrado:</span>
              <span class="amount income">{{ formatCurrency(goalsStats.totalSavedAmount) }}</span>
            </div>
            <div class="amount-row">
              <span>Objetivo:</span>
              <span class="amount">{{ formatCurrency(goalsStats.totalTargetAmount) }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Botón de descarga -->
      <div class="download-section">
        <ion-button expand="block" (click)="downloadReport()" class="download-full-btn">
          <ion-icon name="download" slot="start"></ion-icon>
          Descargar Reporte Completo
        </ion-button>
      </div>
    </div>

    <!-- Espaciado inferior -->
    <div style="height: 100px;"></div>
  </div>

</ion-content>
