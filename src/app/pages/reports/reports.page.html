<!--
  Página de Reportes Financieros
  Muestra gráficos y resúmenes de las finanzas del usuario
-->

<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Reportes</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="downloadReport()">
        <ion-icon slot="icon-only" name="download-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  
  <!-- Encabezado grande -->
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Reportes</ion-title>
    </ion-toolbar>
  </ion-header>

  <!-- Loading -->
  <div *ngIf="isLoading" class="loading-container">
    <ion-spinner name="crescent" color="primary"></ion-spinner>
    <p class="text-muted">Generando reportes...</p>
  </div>

  <!-- Contenido -->
  <div *ngIf="!isLoading && summary">
    
    <!-- Selector de Vista -->
    <div class="view-selector">
      <ion-segment [value]="selectedView" (ionChange)="onViewChange($event)">
        <ion-segment-button value="charts">
          <ion-label>Gráficos</ion-label>
        </ion-segment-button>
        <ion-segment-button value="summary">
          <ion-label>Resumen</ion-label>
        </ion-segment-button>
      </ion-segment>
    </div>

    <!-- Vista de Gráficos -->
    <div *ngIf="selectedView === 'charts'" class="charts-container">
      
      <!-- Gráfico de Pastel - Gastos por Categoría -->
      <ion-card *ngIf="summary.currentMonth.expense > 0">
        <ion-card-content>
          <div class="chart-wrapper">
            <canvas #pieChartCanvas></canvas>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Gráfico de Barras - Ingresos vs Gastos -->
      <ion-card>
        <ion-card-content>
          <div class="chart-wrapper">
            <canvas #barChartCanvas></canvas>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Gráfico de Líneas - Tendencia de Balance -->
      <ion-card>
        <ion-card-content>
          <div class="chart-wrapper">
            <canvas #lineChartCanvas></canvas>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Gráfico de Progreso de Metas -->
      <ion-card *ngIf="summary.goals.active > 0">
        <ion-card-content>
          <div class="chart-wrapper">
            <canvas #goalsChartCanvas></canvas>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Mensaje si no hay datos -->
      <div *ngIf="summary.totalTransactions === 0" class="empty-state">
        <ion-icon name="stats-chart-outline" size="large" color="medium"></ion-icon>
        <h2>No hay datos suficientes</h2>
        <p class="text-muted">
          Comienza registrando transacciones para ver tus gráficos y reportes
        </p>
      </div>
    </div>

    <!-- Vista de Resumen Ejecutivo -->
    <div *ngIf="selectedView === 'summary'" class="summary-container">
      
      <!-- Resumen del Mes Actual -->
      <ion-card class="summary-card">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="calendar" color="primary"></ion-icon>
            Mes Actual
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-list>
            <ion-item lines="none">
              <ion-icon name="arrow-down-circle" slot="start" color="success"></ion-icon>
              <ion-label>
                <p class="text-muted">Ingresos</p>
                <h2 class="text-success">{{ formatCurrency(summary.currentMonth.income) }}</h2>
              </ion-label>
            </ion-item>
            <ion-item lines="none">
              <ion-icon name="arrow-up-circle" slot="start" color="danger"></ion-icon>
              <ion-label>
                <p class="text-muted">Gastos</p>
                <h2 class="text-danger">{{ formatCurrency(summary.currentMonth.expense) }}</h2>
              </ion-label>
            </ion-item>
            <ion-item lines="none">
              <ion-icon name="wallet" slot="start" color="primary"></ion-icon>
              <ion-label>
                <p class="text-muted">Balance</p>
                <h2 [class]="summary.currentMonth.balance >= 0 ? 'text-success' : 'text-danger'">
                  {{ formatCurrency(summary.currentMonth.balance) }}
                </h2>
              </ion-label>
            </ion-item>
            <ion-item lines="none">
              <ion-icon name="receipt" slot="start" color="medium"></ion-icon>
              <ion-label>
                <p class="text-muted">Transacciones</p>
                <h2>{{ summary.currentMonth.transactions }}</h2>
              </ion-label>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>

      <!-- Promedios -->
      <ion-card class="summary-card">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="analytics" color="tertiary"></ion-icon>
            Promedios (6 meses)
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-list>
            <ion-item lines="none">
              <ion-label>
                <p class="text-muted">Ingreso Promedio</p>
                <h3>{{ formatCurrency(summary.averages.income) }}</h3>
              </ion-label>
            </ion-item>
            <ion-item lines="none">
              <ion-label>
                <p class="text-muted">Gasto Promedio</p>
                <h3>{{ formatCurrency(summary.averages.expense) }}</h3>
              </ion-label>
            </ion-item>
            <ion-item lines="none">
              <ion-label>
                <p class="text-muted">Balance Promedio</p>
                <h3 [class]="summary.averages.balance >= 0 ? 'text-success' : 'text-danger'">
                  {{ formatCurrency(summary.averages.balance) }}
                </h3>
              </ion-label>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>

      <!-- Metas de Ahorro -->
      <ion-card class="summary-card">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="flag" color="success"></ion-icon>
            Metas de Ahorro
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-list>
            <ion-item lines="none">
              <ion-label>
                <p class="text-muted">Total de Metas</p>
                <h3>{{ summary.goals.total }}</h3>
              </ion-label>
            </ion-item>
            <ion-item lines="none">
              <ion-label>
                <p class="text-muted">Activas / Completadas</p>
                <h3>{{ summary.goals.active }} / {{ summary.goals.completed }}</h3>
              </ion-label>
            </ion-item>
            <ion-item lines="none">
              <ion-label>
                <p class="text-muted">Progreso General</p>
                <h3 class="text-primary">{{ summary.goals.progress.toFixed(1) }}%</h3>
              </ion-label>
            </ion-item>
            <ion-item lines="none">
              <ion-label>
                <p class="text-muted">Total Ahorrado</p>
                <h3 class="text-success">{{ formatCurrency(summary.goals.saved) }}</h3>
              </ion-label>
            </ion-item>
            <ion-item lines="none">
              <ion-label>
                <p class="text-muted">Objetivo Total</p>
                <h3>{{ formatCurrency(summary.goals.target) }}</h3>
              </ion-label>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>

      <!-- Categoría Más Gastada -->
      <ion-card class="summary-card" *ngIf="summary.topCategory">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="trending-up" color="warning"></ion-icon>
            Categoría Más Gastada
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="top-category">
            <h2>{{ summary.topCategory.name }}</h2>
            <p class="category-amount">{{ formatCurrency(summary.topCategory.amount) }}</p>
            <p class="category-percentage text-muted">
              {{ summary.topCategory.percentage.toFixed(1) }}% del total de gastos
            </p>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Botón de Descarga -->
      <div class="download-button">
        <ion-button expand="block" (click)="downloadReport()">
          <ion-icon name="download" slot="start"></ion-icon>
          Descargar Reporte Completo
        </ion-button>
      </div>
    </div>

    <!-- Espaciado inferior -->
    <div style="height: 80px;"></div>
  </div>

</ion-content>
